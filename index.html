<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜ê³¼ê³ inside</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .liked { color: #ef4444; font-weight: bold; }
    .dc-table-header { border-top: 2px solid #333; }
    .loader { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #3B4890; 
      border-radius: 50%; 
      width: 20px; 
      height: 20px; 
      animation: spin 1s linear infinite; 
      display: inline-block; 
      margin-left: 8px; 
      vertical-align: middle; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .message-bubble {
      max-width: 70%;
      padding: 0.75rem;
      border-radius: 1rem;
      margin-bottom: 0.5rem;
      word-wrap: break-word;
    }
    .message-mine {
      background-color: #3B4890;
      color: white;
      margin-left: auto;
    }
    .message-theirs {
      background-color: #e5e7eb;
      color: #1f2937;
    }
    .reply-indicator {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-bottom: 0.25rem;
      padding: 0.25rem 0.5rem;
      background-color: rgba(255,255,255,0.2);
      border-radius: 0.25rem;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

<!-- Header -->
<header class="w-full bg-white text-[#3B4890] shadow-md sticky top-0 z-10">
  <div class="max-w-5xl mx-auto p-4 flex justify-between items-center">
    <h1 class="text-3xl font-bold cursor-pointer" onclick="showMain()">ì˜ê³¼ê³ inside</h1>
    <div class="flex gap-2">
      <button id="refreshButton" class="bg-[#3B4890] text-white font-semibold py-1 px-3 rounded text-sm hover:bg-[#2F3A78] transition">
        ğŸ”„ ìƒˆë¡œê³ ì¹¨
      </button>
      <button id="chatButton" class="bg-green-500 text-white font-semibold py-1 px-3 rounded text-sm hover:bg-green-600 transition hidden">
        ğŸ’¬ ì±„íŒ…
      </button>
      <button id="myPageButton" class="bg-purple-500 text-white font-semibold py-1 px-3 rounded text-sm hover:bg-purple-600 transition hidden">
        ğŸ‘¤ ë‚´ ì •ë³´
      </button>
      <button id="loginButton" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded text-sm hover:bg-blue-600 transition">
        ğŸ”‘ ë¡œê·¸ì¸
      </button>
      <button id="logoutButton" class="bg-red-500 text-white font-semibold py-1 px-3 rounded text-sm hover:bg-red-600 transition hidden">
        ğŸšª ë¡œê·¸ì•„ì›ƒ
      </button>
    </div>
  </div>
</header>

<div id="app" class="max-w-5xl mx-auto p-4">
  <!-- ìƒë‹¨ ë²„íŠ¼ -->
  <div class="mb-4 bg-[#3B4890] p-2 rounded-lg shadow-md">
    <button onclick="openGuide()" class="bg-gray-200 text-[#3B4890] px-4 py-2 rounded shadow hover:bg-gray-300 transition-colors font-semibold">
      ğŸ“¢ ì•ˆë‚´ì‚¬í•­
    </button>
    <button onclick="openInquiry()" class="bg-gray-200 text-[#3B4890] px-4 py-2 rounded shadow hover:bg-gray-300 transition-colors ml-2 font-semibold">
      âœ‰ï¸ ë¬¸ì˜í•˜ê¸°
    </button>
  </div>

  <!-- ì•ˆë‚´ì‚¬í•­ í˜ì´ì§€ -->
  <div id="guidePage" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
    <button onclick="closeGuide()" class="bg-gray-200 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold">
      â† ëŒì•„ê°€ê¸°
    </button>
    <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ“¢ ì•ˆë‚´ì‚¬í•­</h2>
    <div class="space-y-2 text-gray-700">
      <p>1. ìš•ì„¤, ë¹„ë°© ê¸ˆì§€.</p>
      <p>2. ì‘ì„±ê¸€ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
      <p class="pl-4 text-sm">IP ìˆ˜ì§‘ì¤‘ì´ë©° í…ŒëŸ¬ë‚˜ ë¬¸ì œë˜ëŠ” ìƒí™©ì´ ì•„ë‹Œ ë‹¤ë¥¸ ìš©ë„ë¡œ ì ˆëŒ€ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p>3. ì„œë²„ ìì›ì´ ë¶€ì¡±í•  ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>
      <p>4. í…ŒëŸ¬ í•˜ì§€ ë§ˆì„¸ìš” (IPì£¼ì†Œë¡œ ë³´ë³µí•©ë‹ˆë‹¤.)</p>
      <p>5. ì—¬ëŸ¬ë¶„ì´ ê²Œì‹œí•œ ê¸€ë“¤ì€ AI í•™ìŠµ ë°ì´í„°ë¡œ ì‚¬ìš©ë˜ë©° ìµëª…ì„ ë³´ì¥í•©ë‹ˆë‹¤.</p>
      <p>6. í•˜ì§€ë§Œ ê°œì¸ì •ë³´ë¥¼ ê²Œì‹œí•  ê²½ìš° í•™ìŠµë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê°€ê¸‰ì  ê°œì¸ì •ë³´ ê²Œì‹œë¥¼ ìì œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
      <p>7. ë¬¸ì˜ì‚¬í•­ì€ ë¬¸ì˜í•˜ê¸°ì—ì„œ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
      <p>8. ë²„ê·¸ë‚˜ ë¬¸ì œì ë“±ë„ ë¬¸ì˜í•˜ê¸°ì—ì„œ ì‘ì„±í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.</p>
      <p>9. ì¶”í›„ ì—…ë°ì´íŠ¸ê°€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.</p>
      <p>10. ì´ ì‚¬ì´íŠ¸ì—ì„œ í™œë™í•˜ëŠ”ê²ƒì€ ìœ„ ì‚¬í•­ì— ë™ì˜í•˜ëŠ”ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.</p>
      <p>11. ì‚­ì œ ìš”ì²­ì€ ì•„ë˜ ì´ë©”ì¼ë¡œ ì •í™•í•œ ê¸€ê³¼ ì‚¬ìœ , ìº¡ì³ë³¸ì„ ë³´ë‚´ì£¼ì…”ì•¼ ì§„í–‰ë©ë‹ˆë‹¤.</p>
      <p class="font-semibold">ì´ë©”ì¼ : 2024010203@ushs.hs.kr</p>
    </div>
  </div>

  <!-- ë¬¸ì˜í•˜ê¸° í˜ì´ì§€ -->
  <div id="inquiryPage" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
    <button onclick="closeInquiry()" class="bg-gray-200 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold">
      â† ëŒì•„ê°€ê¸°
    </button>
    <h2 class="text-2xl font-bold mb-4 border-b pb-2">âœ‰ï¸ ë¬¸ì˜í•˜ê¸°</h2>
    <textarea id="inquiryContent" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="border p-2 mb-2 w-full rounded h-32 focus:outline-none focus:ring-2 focus:ring-[#3B4890]"></textarea>
    <button onclick="submitInquiry()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
      ë¬¸ì˜ ì „ì†¡
    </button>
    <p id="inquiryMsg" class="mt-2 text-sm"></p>
  </div>

  <!-- ë©”ì¸ í˜ì´ì§€ (ì»¤ë®¤ë‹ˆí‹° ëª©ë¡) -->
  <div id="mainPage" class="grid gap-4 mb-6"></div>

  <!-- ì»¤ë®¤ë‹ˆí‹° í˜ì´ì§€ (ê²Œì‹œê¸€ ëª©ë¡) -->
  <div id="communityPage" class="hidden">
    <button onclick="showMain()" class="bg-gray-200 border border-gray-300 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold">
      â† ë©”ì¸ìœ¼ë¡œ
    </button>
    <h2 id="communityTitle" class="text-3xl font-bold mb-4 text-[#3B4890]"></h2>
    
    <!-- ê¸€ì“°ê¸° í¼ -->
    <div id="postWriteForm" class="bg-white p-4 rounded-lg shadow-md mb-4">
      <input id="title" placeholder="ì œëª©" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <textarea id="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="border w-full p-2 mb-2 rounded h-28 focus:outline-none focus:ring-2 focus:ring-[#3B4890]"></textarea>
      <input id="postPassword" type="password" placeholder="ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ (ìˆ˜ì •/ì‚­ì œ ì‹œ í•„ìš”)" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <div class="mb-2">
        <label for="imageFile" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ ì²¨ë¶€ (ì„ íƒ, 5MB ì´í•˜):</label>
        <input type="file" id="imageFile" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#e0e7ff] file:text-[#3B4890] hover:file:bg-[#c7d2fe]">
      </div>
      <button id="submitBtn" onclick="submitPost()" class="bg-[#3B4890] text-white px-4 py-2 rounded hover:bg-[#2F3A78] transition-colors font-semibold disabled:opacity-50">
        ê¸€ ë“±ë¡
      </button>
      <span id="loadingSpinner" class="loader hidden"></span>
      <p id="resultMsg" class="mt-2 text-sm"></p>
    </div>

    <!-- ê²€ìƒ‰ -->
    <input id="searchBox" type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”." oninput="renderPosts()" class="border w-full p-2 mb-4 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />

    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    <div id="postsList" class="bg-white rounded-lg shadow-md overflow-hidden">
      <table class="w-full text-sm dc-table-header">
        <thead class="bg-gray-50">
          <tr class="border-b">
            <th class="p-3 text-left">ì œëª©</th>
            <th class="p-3 w-24">ì‘ì„±ì</th>
            <th class="p-3 w-28">ë‚ ì§œ</th>
            <th class="p-3 w-16">ì¡°íšŒ</th>
          </tr>
        </thead>
        <tbody id="postsTableBody"></tbody>
      </table>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div id="pagination" class="flex justify-center items-center gap-2 mt-4 mb-4">
      <button onclick="goToPage(1)" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm font-semibold disabled:opacity-50" id="firstPageBtn">
        â‰ª ì²« í˜ì´ì§€
      </button>
      <button onclick="goToPage(currentPage - 1)" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm font-semibold disabled:opacity-50" id="prevPageBtn">
        â€¹ ì´ì „
      </button>
      <span id="pageInfo" class="px-4 py-1 text-sm font-semibold text-gray-700"></span>
      <button onclick="goToPage(currentPage + 1)" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm font-semibold disabled:opacity-50" id="nextPageBtn">
        ë‹¤ìŒ â€º
      </button>
      <button onclick="goToPage(totalPages)" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm font-semibold disabled:opacity-50" id="lastPageBtn">
        ë§ˆì§€ë§‰ í˜ì´ì§€ â‰«
      </button>
    </div>

    <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
    <div id="postDetail" class="hidden bg-white p-6 rounded-lg shadow-md">
      <button onclick="backToList()" class="bg-gray-200 border border-gray-300 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold">
        â† ëª©ë¡ìœ¼ë¡œ
      </button>
      <div class="border-b-2 border-gray-300 pb-3 mb-3">
        <h2 id="detailTitle" class="text-2xl font-bold mb-2"></h2>
        <div id="detailMeta" class="text-sm text-gray-600 bg-gray-50 p-2 rounded"></div>
        <div id="detailActions" class="mt-2 flex gap-2"></div>
      </div>
      <div id="detailImageContainer" class="mb-4"></div>
      <div id="detailContentDisplay" class="mb-5 whitespace-pre-wrap min-h-[100px]"></div>
      <div id="detailEditForm" class="hidden mb-5">
        <textarea id="editContent" class="border w-full p-2 rounded h-40 focus:outline-none focus:ring-2 focus:ring-[#3B4890]"></textarea>
        <div class="mt-2 flex gap-2">
          <button onclick="submitUpdate()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ì™„ë£Œ</button>
          <button onclick="cancelEdit()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
        </div>
      </div>

      <!-- ëŒ“ê¸€ -->
      <div class="border-t pt-4">
        <h3 class="font-bold mb-3 text-lg">ğŸ’¬ ëŒ“ê¸€</h3>
        <div id="commentsList" class="mb-4"></div>
        <div class="bg-gray-50 p-3 rounded">
          <input id="commentAuthor" placeholder="ì‘ì„±ì" class="border p-2 mb-2 w-full rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
          <textarea id="commentContent" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="border p-2 mb-2 w-full rounded h-20 focus:outline-none focus:ring-2 focus:ring-[#3B4890]"></textarea>
          <button onclick="submitComment()" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 font-semibold">ëŒ“ê¸€ ë“±ë¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì±„íŒ… í˜ì´ì§€ -->
  <div id="chatPage" class="hidden">
    <button onclick="closeChatPage()" class="bg-gray-200 border border-gray-300 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold">
      â† ë’¤ë¡œê°€ê¸°
    </button>
    <h2 class="text-3xl font-bold mb-4 text-[#3B4890]">ğŸ’¬ ì±„íŒ…</h2>

    <!-- ì¹œêµ¬ ê´€ë¦¬ íƒ­ -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
      <div class="flex gap-2 mb-4 border-b">
        <button onclick="showFriendTab('list')" id="friendListTab" class="px-4 py-2 font-semibold border-b-2 border-[#3B4890] text-[#3B4890]">ì¹œêµ¬ ëª©ë¡</button>
        <button onclick="showFriendTab('search')" id="friendSearchTab" class="px-4 py-2 font-semibold text-gray-500">ì¹œêµ¬ ì¶”ê°€</button>
        <button onclick="showFriendTab('requests')" id="friendRequestsTab" class="px-4 py-2 font-semibold text-gray-500">ë°›ì€ ìš”ì²­</button>
      </div>

      <!-- ì¹œêµ¬ ëª©ë¡ -->
      <div id="friendListView">
        <div id="friendList" class="space-y-2"></div>
      </div>

      <!-- ì¹œêµ¬ ê²€ìƒ‰ -->
      <div id="friendSearchView" class="hidden">
        <input id="friendSearchInput" type="text" placeholder="ì‚¬ìš©ì ID ë˜ëŠ” ë‹‰ë„¤ì„ ê²€ìƒ‰" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
        <button onclick="searchFriend()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ê²€ìƒ‰</button>
        <div id="searchResults" class="mt-4 space-y-2"></div>
      </div>

      <!-- ë°›ì€ ì¹œêµ¬ ìš”ì²­ -->
      <div id="friendRequestsView" class="hidden">
        <div id="pendingRequests" class="space-y-2"></div>
      </div>
    </div>

    <!-- ì±„íŒ…ì°½ -->
    <div id="chatWindow" class="hidden bg-white p-4 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-4 border-b pb-2">
        <h3 id="chatWindowTitle" class="text-xl font-bold"></h3>
        <button onclick="closeChatWindow()" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <div id="chatMessages" class="h-96 overflow-y-auto mb-4 space-y-2"></div>
      <div class="flex gap-2">
        <input type="file" id="chatImageInput" accept="image/*" class="hidden" onchange="handleChatImage()" />
        <button onclick="document.getElementById('chatImageInput').click()" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">ğŸ“</button>
        <input id="chatMessageInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="border flex-1 p-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" onkeypress="if(event.key==='Enter') sendChatMessage()" />
        <button onclick="sendChatMessage()" class="bg-[#3B4890] text-white px-4 py-2 rounded hover:bg-[#2F3A78]">ì „ì†¡</button>
      </div>
    </div>
  </div>

  <!-- ë‚´ ì •ë³´ í˜ì´ì§€ -->
  <div id="myPage" class="hidden bg-white p-6 rounded-lg shadow-md">
    <button onclick="closeMyPage()" class="bg-gray-200 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold">
      â† ëŒì•„ê°€ê¸°
    </button>
    <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ‘¤ ë‚´ ì •ë³´</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ì•„ì´ë””</label>
        <input id="myUserId" type="text" disabled class="border w-full p-2 rounded bg-gray-100" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ë‹‰ë„¤ì„</label>
        <input id="myNickname" type="text" class="border w-full p-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
        <input id="myEmail" type="email" class="border w-full p-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      </div>
      <div class="flex items-center gap-2">
        <input id="twoFactorToggle" type="checkbox" class="w-5 h-5" onchange="handleTwoFactorToggle()" />
        <label for="twoFactorToggle" class="text-sm font-medium text-gray-700">2ì°¨ ì¸ì¦ í™œì„±í™” (ì´ë©”ì¼ ì¸ì¦)</label>
      </div>
      <button onclick="updateProfile()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">í”„ë¡œí•„ ì—…ë°ì´íŠ¸</button>
      <p id="myPageMsg" class="text-sm"></p>
    </div>
  </div>
</div>

<!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="authModal" class="modal">
  <div class="modal-content">
    <h2 id="authModalTitle" class="text-2xl font-bold mb-4">ğŸ”‘ ë¡œê·¸ì¸</h2>
    <div id="authModalContent"></div>
  </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ëª¨ë‹¬ -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-4">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h2>
    <p class="mb-4 text-gray-600">ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input id="modalPasswordInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
    <p id="modalPasswordError" class="text-red-500 text-sm mb-2"></p>
    <div class="flex gap-2">
      <button onclick="submitPasswordModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex-1">í™•ì¸</button>
      <button onclick="closePasswordModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 flex-1">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- 2ì°¨ ì¸ì¦ ëª¨ë‹¬ -->
<div id="twoFactorModal" class="modal">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-4">ğŸ“§ 2ì°¨ ì¸ì¦</h2>
    <p class="mb-4 text-gray-600">ì´ë©”ì¼ë¡œ ì „ì†¡ëœ 6ìë¦¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <p class="mb-2 text-sm text-gray-500">ì´ë©”ì¼: <span id="twoFactorEmail"></span></p>
    <input id="twoFactorCodeInput" type="text" placeholder="ì¸ì¦ ì½”ë“œ (6ìë¦¬)" maxlength="6" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
    <p id="twoFactorError" class="text-red-500 text-sm mb-2"></p>
    <div class="flex gap-2">
      <button onclick="submitTwoFactorCode()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex-1">í™•ì¸</button>
      <button onclick="resendVerificationCode()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">ì¬ì „ì†¡</button>
      <button onclick="closeTwoFactorModal()" class="bg-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-400">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
  // ===== í™˜ê²½ ì„¤ì • =====
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyTNAisK8Igwjxy-P9fQT7NtFnI7ht92vDnaovjnl0KScZZSa3ijpL1iKwFwiPgcJ5SoA/exec";

  // ===== ì»¤ë®¤ë‹ˆí‹° ì„¤ì • =====
  const communityGroups = {
    "ì „ì²´": ["ì „ì²´ ì»¤ë®¤ë‹ˆí‹°"],
    "ìˆ˜í•™Â·ê³¼í•™": ["ìˆ˜í•™ ì»¤ë®¤ë‹ˆí‹°", "ê³¼í•™ ì»¤ë®¤ë‹ˆí‹°"],
    "ì˜ì¬í•™êµ": [
      "í•œêµ­ê³¼í•™ì˜ì¬í•™êµ", "ì„œìš¸ê³¼í•™ê³ ë“±í•™êµ", "ê²½ê¸°ê³¼í•™ê³ ë“±í•™êµ", "ì„¸ì¢…ê³¼í•™ì˜ˆìˆ ì˜ì¬í•™êµ",
      "ì¸ì²œê³¼í•™ì˜ˆìˆ ì˜ì¬í•™êµ", "ëŒ€êµ¬ê³¼í•™ê³ ë“±í•™êµ", "ëŒ€ì „ê³¼í•™ê³ ë“±í•™êµ", "ê´‘ì£¼ê³¼í•™ê³ ë“±í•™êµ"
    ],
    "ê³¼í•™ê³ ": [
      "í•œì„±ê³¼í•™ê³ ë“±í•™êµ", "ì„¸ì¢…ê³¼í•™ê³ ë“±í•™êµ", "ë¶€ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ë¶€ì‚°ì¼ê³¼í•™ê³ ë“±í•™êµ",
      "ëŒ€êµ¬ì¼ê³¼í•™ê³ ë“±í•™êµ", "ì¸ì²œê³¼í•™ê³ ë“±í•™êµ", "ì¸ì²œì§„ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ëŒ€ì „ë™ì‹ ê³¼í•™ê³ ë“±í•™êµ",
      "ìš¸ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ê²½ê¸°ë¶ê³¼í•™ê³ ë“±í•™êµ", "ê°•ì›ê³¼í•™ê³ ë“±í•™êµ", "ì¶©ë¶ê³¼í•™ê³ ë“±í•™êµ",
      "ì¶©ë‚¨ê³¼í•™ê³ ë“±í•™êµ", "ì „ë¶ê³¼í•™ê³ ë“±í•™êµ", "ì „ë‚¨ê³¼í•™ê³ ë“±í•™êµ", "ê²½ë¶ê³¼í•™ê³ ë“±í•™êµ",
      "ê²½ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ê²½ë‚¨ê³¼í•™ê³ ë“±í•™êµ", "ì°½ì›ê³¼í•™ê³ ë“±í•™êµ", "ì œì£¼ê³¼í•™ê³ ë“±í•™êµ"
    ]
  };

  // ===== ì „ì—­ ë³€ìˆ˜ =====
  let currentCommunity = null;
  let currentPosts = [];
  let currentPostId = null;
  let currentUser = null;
  let currentPasswordModalAction = null;
  let currentChatRoomId = null;
  let chatPollingInterval = null;
  let currentPage = 1;
  let totalPages = 1;
  let postsPerPage = 10;

  // ===== DOM ì°¸ì¡° =====
  const mainPage = document.getElementById("mainPage");
  const communityPage = document.getElementById("communityPage");
  const guidePage = document.getElementById("guidePage");
  const inquiryPage = document.getElementById("inquiryPage");
  const chatPage = document.getElementById("chatPage");
  const myPage = document.getElementById("myPage");
  const postWriteForm = document.getElementById("postWriteForm");
  const searchBox = document.getElementById("searchBox");
  const postsList = document.getElementById("postsList");
  const postDetail = document.getElementById("postDetail");
  const postsTableBody = document.getElementById("postsTableBody");
  const imageFileInput = document.getElementById("imageFile");
  const submitButton = document.getElementById("submitBtn");
  const loadingSpinner = document.getElementById("loadingSpinner");
  const resultMsg = document.getElementById("resultMsg");
  const detailImageContainer = document.getElementById("detailImageContainer");
  const inquiryContentEl = document.getElementById("inquiryContent");
  const inquiryMsgEl = document.getElementById("inquiryMsg");

  // ===== ì´ˆê¸°í™” =====
  function init() {
    renderMainPage();
    updateAuthUI();
    
    document.getElementById('refreshButton').addEventListener('click', () => {
      if (currentCommunity) {
        loadPosts();
      } else {
        renderMainPage();
      }
    });

    document.getElementById('loginButton').addEventListener('click', showLoginModal);
    document.getElementById('logoutButton').addEventListener('click', logout);
    document.getElementById('chatButton').addEventListener('click', openChatPage);
    document.getElementById('myPageButton').addEventListener('click', openMyPage);

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë³µì›
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      currentUser = JSON.parse(savedUser);
      updateAuthUI();
    }
  }

  // ===== ì¸ì¦ UI ì—…ë°ì´íŠ¸ =====
  function updateAuthUI() {
    const loginBtn = document.getElementById('loginButton');
    const logoutBtn = document.getElementById('logoutButton');
    const chatBtn = document.getElementById('chatButton');
    const myPageBtn = document.getElementById('myPageButton');

    if (currentUser) {
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      chatBtn.classList.remove('hidden');
      myPageBtn.classList.remove('hidden');
    } else {
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      chatBtn.classList.add('hidden');
      myPageBtn.classList.add('hidden');
    }
  }

  // ===== í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜ë“¤ =====
  function showMain() {
    currentCommunity = null;
    currentPosts = [];
    currentPostId = null;
    mainPage.classList.remove("hidden");
    communityPage.classList.add("hidden");
    guidePage.classList.add("hidden");
    inquiryPage.classList.add("hidden");
    chatPage.classList.add("hidden");
    myPage.classList.add("hidden");
  }

  function openGuide() {
    mainPage.classList.add("hidden");
    communityPage.classList.add("hidden");
    guidePage.classList.remove("hidden");
    inquiryPage.classList.add("hidden");
    chatPage.classList.add("hidden");
    myPage.classList.add("hidden");
  }

  function closeGuide() {
    guidePage.classList.add("hidden");
    mainPage.classList.remove("hidden");
  }

  function openInquiry() {
    mainPage.classList.add("hidden");
    communityPage.classList.add("hidden");
    guidePage.classList.add("hidden");
    inquiryPage.classList.remove("hidden");
    chatPage.classList.add("hidden");
    myPage.classList.add("hidden");
  }

  function closeInquiry() {
    inquiryPage.classList.add("hidden");
    mainPage.classList.remove("hidden");
    inquiryContentEl.value = "";
    inquiryMsgEl.textContent = "";
  }

  function openChatPage() {
    if (!currentUser) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }
    mainPage.classList.add("hidden");
    communityPage.classList.add("hidden");
    guidePage.classList.add("hidden");
    inquiryPage.classList.add("hidden");
    chatPage.classList.remove("hidden");
    myPage.classList.add("hidden");
    loadFriendList();
    loadPendingRequests();
  }

  function closeChatPage() {
    chatPage.classList.add("hidden");
    mainPage.classList.remove("hidden");
    closeChatWindow();
  }

  function openMyPage() {
    if (!currentUser) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }
    mainPage.classList.add("hidden");
    communityPage.classList.add("hidden");
    guidePage.classList.add("hidden");
    inquiryPage.classList.add("hidden");
    chatPage.classList.add("hidden");
    myPage.classList.remove("hidden");
    loadUserProfile();
  }

  function closeMyPage() {
    myPage.classList.add("hidden");
    mainPage.classList.remove("hidden");
  }

  function openCommunity(communityId) {
    if (!WEB_APP_URL || WEB_APP_URL.includes("YOUR_NEW_APPS_SCRIPT_URL_HERE")) {
      alert("ì˜¤ë¥˜: ì›¹ ì•± URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }
    currentCommunity = communityId;
    currentPage = 1; // í˜ì´ì§€ ì´ˆê¸°í™”
    mainPage.classList.add("hidden");
    communityPage.classList.remove("hidden");
    guidePage.classList.add("hidden");
    inquiryPage.classList.add("hidden");
    chatPage.classList.add("hidden");
    myPage.classList.add("hidden");
    document.getElementById("communityTitle").textContent = communityId;
    backToList();
    loadPosts(1);
  }

  // ===== ë©”ì¸ í˜ì´ì§€ ë Œë”ë§ =====
  function renderMainPage() {
    mainPage.innerHTML = "";
    Object.keys(communityGroups).forEach(groupName => {
      const container = document.createElement("div");
      container.className = "bg-white p-4 rounded-lg shadow-md mb-4";
      const header = document.createElement("h3");
      header.className = "font-bold text-lg mb-3 border-b-2 border-[#3B4890] pb-2";
      header.textContent = groupName;
      container.appendChild(header);
      const btnDiv = document.createElement("div");
      btnDiv.className = "flex flex-wrap gap-2";
      communityGroups[groupName].forEach(c => {
        const btn = document.createElement("button");
        btn.className = "bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-50 hover:border-[#3B4890] hover:text-[#3B4890] transition-colors";
        btn.textContent = c;
        btn.onclick = () => openCommunity(c);
        btnDiv.appendChild(btn);
      });
      container.appendChild(btnDiv);
      mainPage.appendChild(container);
    });
  }

  // ===== ì¸ì¦ ì‹œìŠ¤í…œ =====
  function showLoginModal() {
    const modal = document.getElementById('authModal');
    const title = document.getElementById('authModalTitle');
    const content = document.getElementById('authModalContent');
    
    title.textContent = "ğŸ”‘ ë¡œê·¸ì¸";
    content.innerHTML = `
      <input id="loginUserId" type="text" placeholder="ì•„ì´ë””" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <input id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <p id="loginError" class="text-red-500 text-sm mb-2"></p>
      <div class="flex gap-2 mb-4">
        <button onclick="submitLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex-1">ë¡œê·¸ì¸</button>
        <button onclick="closeAuthModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 flex-1">ì·¨ì†Œ</button>
      </div>
      <div class="text-center">
        <button onclick="showSignUpForm()" class="text-blue-500 hover:underline text-sm">íšŒì›ê°€ì…</button>
      </div>
    `;
    modal.classList.add('active');
  }

  function showSignUpForm() {
    const title = document.getElementById('authModalTitle');
    const content = document.getElementById('authModalContent');
    
    title.textContent = "ğŸ“ íšŒì›ê°€ì…";
    content.innerHTML = `
      <input id="signupUserId" type="text" placeholder="ì•„ì´ë””" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <input id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <input id="signupPasswordConfirm" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <input id="signupNickname" type="text" placeholder="ë‹‰ë„¤ì„" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <input id="signupEmail" type="email" placeholder="ì´ë©”ì¼" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <p id="signupError" class="text-red-500 text-sm mb-2"></p>
      <div class="flex gap-2 mb-4">
        <button onclick="submitSignUp()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex-1">ê°€ì…í•˜ê¸°</button>
        <button onclick="closeAuthModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 flex-1">ì·¨ì†Œ</button>
      </div>
      <div class="text-center">
        <button onclick="showLoginModal()" class="text-blue-500 hover:underline text-sm">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    `;
  }

  function closeAuthModal() {
    document.getElementById('authModal').classList.remove('active');
  }

  async function submitLogin() {
    const userId = document.getElementById('loginUserId').value;
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');

    if (!userId || !password) {
      errorEl.textContent = "ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "login", data: { userId, password } })
      });

      const result = await response.json();

      if (result.success) {
        // 2ì°¨ ì¸ì¦ í™•ì¸
        if (result.user.twoFactorEnabled) {
          // 2ì°¨ ì¸ì¦ ì½”ë“œ ë°œì†¡
          const verifyResponse = await fetch(WEB_APP_URL, {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ 
              action: "sendVerificationEmail", 
              data: { email: result.user.email, purpose: 'login' } 
            })
          });

          const verifyResult = await verifyResponse.json();

          if (verifyResult.success) {
            closeAuthModal();
            showTwoFactorModal(result.user);
          } else {
            errorEl.textContent = verifyResult.message || "ì¸ì¦ ì½”ë“œ ë°œì†¡ ì‹¤íŒ¨";
          }
        } else {
          // 2ì°¨ ì¸ì¦ ë¹„í™œì„±í™” - ë°”ë¡œ ë¡œê·¸ì¸
          currentUser = result.user;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          updateAuthUI();
          closeAuthModal();
          alert("ë¡œê·¸ì¸ ì„±ê³µ!");
        }
      } else {
        errorEl.textContent = result.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨";
      }
    } catch (err) {
      console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", err);
      errorEl.textContent = "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  async function submitSignUp() {
    const userId = document.getElementById('signupUserId').value;
    const password = document.getElementById('signupPassword').value;
    const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
    const nickname = document.getElementById('signupNickname').value;
    const email = document.getElementById('signupEmail').value;
    const errorEl = document.getElementById('signupError');

    if (!userId || !password || !nickname || !email) {
      errorEl.textContent = "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    if (password !== passwordConfirm) {
      errorEl.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ 
          action: "signUp", 
          data: { userId, password, nickname, email } 
        })
      });

      const result = await response.json();

      if (result.success) {
        alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        showLoginModal();
      } else {
        errorEl.textContent = result.message || "íšŒì›ê°€ì… ì‹¤íŒ¨";
      }
    } catch (err) {
      console.error("íšŒì›ê°€ì… ì˜¤ë¥˜:", err);
      errorEl.textContent = "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    updateAuthUI();
    showMain();
    alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  // ===== 2ì°¨ ì¸ì¦ ì‹œìŠ¤í…œ =====
  let pendingTwoFactorUser = null;

  function showTwoFactorModal(user) {
    pendingTwoFactorUser = user;
    const modal = document.getElementById('twoFactorModal');
    document.getElementById('twoFactorEmail').textContent = user.email;
    document.getElementById('twoFactorCodeInput').value = "";
    document.getElementById('twoFactorError').textContent = "";
    modal.classList.add('active');
  }

  function closeTwoFactorModal() {
    document.getElementById('twoFactorModal').classList.remove('active');
    pendingTwoFactorUser = null;
  }

  async function submitTwoFactorCode() {
    const code = document.getElementById('twoFactorCodeInput').value;
    const errorEl = document.getElementById('twoFactorError');

    if (!code || code.length !== 6) {
      errorEl.textContent = "6ìë¦¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ 
          action: "verifyCode", 
          data: { email: pendingTwoFactorUser.email, code, purpose: 'login' } 
        })
      });

      const result = await response.json();

      if (result.success) {
        currentUser = pendingTwoFactorUser;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateAuthUI();
        closeTwoFactorModal();
        alert("ë¡œê·¸ì¸ ì„±ê³µ!");
      } else {
        errorEl.textContent = result.message || "ì¸ì¦ ì‹¤íŒ¨";
      }
    } catch (err) {
      console.error("2ì°¨ ì¸ì¦ ì˜¤ë¥˜:", err);
      errorEl.textContent = "ì¸ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  async function resendVerificationCode() {
    if (!pendingTwoFactorUser) return;

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ 
          action: "sendVerificationEmail", 
          data: { email: pendingTwoFactorUser.email, purpose: 'login' } 
        })
      });

      const result = await response.json();

      if (result.success) {
        alert("ì¸ì¦ ì½”ë“œê°€ ì¬ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        alert(result.message || "ì¬ì „ì†¡ ì‹¤íŒ¨");
      }
    } catch (err) {
      console.error("ì¬ì „ì†¡ ì˜¤ë¥˜:", err);
      alert("ì¬ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // ===== ë‚´ ì •ë³´ í˜ì´ì§€ =====
  async function loadUserProfile() {
    if (!currentUser) return;

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ 
          action: "getUserProfile", 
          data: { userId: currentUser.userId } 
        })
      });

      const result = await response.json();

      if (result.success) {
        document.getElementById('myUserId').value = result.user.userId;
        document.getElementById('myNickname').value = result.user.nickname;
        document.getElementById('myEmail').value = result.user.email;
        document.getElementById('twoFactorToggle').checked = result.user.twoFactorEnabled;
        currentUser = result.user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
      }
    } catch (err) {
      console.error("í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:", err);
    }
  }

  async function updateProfile() {
    const nickname = document.getElementById('myNickname').value;
    const email = document.getElementById('myEmail').value;
    const msgEl = document.getElementById('myPageMsg');

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ 
          action: "updateUserProfile", 
          data: { userId: currentUser.userId, nickname, email } 
        })
      });

      const result = await response.json();

      if (result.success) {
        msgEl.textContent = "âœ… " + result.message;
        msgEl.className = "text-sm text-green-500";
        currentUser = result.user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        setTimeout(() => { msgEl.textContent = ""; }, 3000);
      } else {
        msgEl.textContent = "âŒ " + result.message;
        msgEl.className = "text-sm text-red-500";
      }
    } catch (err) {
      console.error("í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", err);
      msgEl.textContent = "âŒ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
      msgEl.className = "text-sm text-red-500";
    }
  }

  async function handleTwoFactorToggle() {
    const enable = document.getElementById('twoFactorToggle').checked;
    const msgEl = document.getElementById('myPageMsg');

    if (enable) {
      // 2ì°¨ ì¸ì¦ í™œì„±í™” - ì´ë©”ì¼ ì¸ì¦ í•„ìš”
      try {
        const response = await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ 
            action: "sendVerificationEmail", 
            data: { email: currentUser.email, purpose: 'enable2fa' } 
          })
        });

        const result = await response.json();

        if (result.success) {
          const code = prompt("ì´ë©”ì¼ë¡œ ì „ì†¡ëœ 6ìë¦¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
          if (code) {
            const verifyResponse = await fetch(WEB_APP_URL, {
              method: "POST",
              mode: "cors",
              cache: "no-cache",
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify({ 
                action: "verifyCode", 
                data: { email: currentUser.email, code, purpose: 'enable2fa' } 
              })
            });

            const verifyResult = await verifyResponse.json();

            if (verifyResult.success) {
              await toggleTwoFactorAPI(true);
            } else {
              alert(verifyResult.message || "ì¸ì¦ ì‹¤íŒ¨");
              document.getElementById('twoFactorToggle').checked = false;
            }
          } else {
            document.getElementById('twoFactorToggle').checked = false;
          }
        } else {
          alert(result.message || "ì¸ì¦ ì½”ë“œ ë°œì†¡ ì‹¤íŒ¨");
          document.getElementById('twoFactorToggle').checked = false;
        }
      } catch (err) {
        console.error("2ì°¨ ì¸ì¦ í™œì„±í™” ì˜¤ë¥˜:", err);
        document.getElementById('twoFactorToggle').checked = false;
      }
    } else {
      // 2ì°¨ ì¸ì¦ ë¹„í™œì„±í™”
      if (confirm("2ì°¨ ì¸ì¦ì„ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        await toggleTwoFactorAPI(false);
      } else {
        document.getElementById('twoFactorToggle').checked = true;
      }
    }
  }

  async function toggleTwoFactorAPI(enable) {
    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ 
          action: "toggleTwoFactor", 
          data: { userId: currentUser.userId, enable } 
        })
      });

      const result = await response.json();

      if (result.success) {
        currentUser.twoFactorEnabled = enable;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        alert(result.message);
      } else {
        alert(result.message || "ì„¤ì • ë³€ê²½ ì‹¤íŒ¨");
        document.getElementById('twoFactorToggle').checked = !enable;
      }
    } catch (err) {
      console.error("2ì°¨ ì¸ì¦ ì„¤ì • ì˜¤ë¥˜:", err);
      document.getElementById('twoFactorToggle').checked = !enable;
    }
  }

  // ===== ê²Œì‹œê¸€ ê´€ë¦¬ =====
  async function loadPosts(page = 1) {
    if (!currentCommunity) return;

    currentPage = page;
    postsTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

    try {
      const response = await fetch(`${WEB_APP_URL}?action=getPosts&community=${encodeURIComponent(currentCommunity)}&page=${page}`);
      const data = await response.json();

      if (data && data.success === false) {
        postsTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${data.message}</td></tr>`;
        currentPosts = [];
        return;
      }

      // ë¬¸ì„œ ìš”êµ¬ì‚¬í•­: totalPosts í™œìš©
      if (data.success && Array.isArray(data.posts)) {
        currentPosts = data.posts;
        
        // ì´ í˜ì´ì§€ ìˆ˜ ê³„ì‚° (ë¬¸ì„œ ìš”êµ¬ì‚¬í•­)
        totalPages = Math.ceil(data.totalPosts / postsPerPage);
        if (totalPages === 0) totalPages = 1;
        
        renderPosts();
        renderPagination();
      } else if (Array.isArray(data)) {
        // êµ¬ë²„ì „ í˜¸í™˜ (totalPosts ì—†ì„ ê²½ìš°)
        currentPosts = data;
        
        if (data.length < postsPerPage) {
          totalPages = currentPage;
        } else {
          totalPages = currentPage + 1;
        }
        
        renderPosts();
        renderPagination();
      } else {
        postsTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜.</td></tr>';
        currentPosts = [];
      }
    } catch (err) {
      console.error("getPosts fetch failed:", err);
      postsTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
    }
  }

  function renderPagination() {
    const pageInfo = document.getElementById('pageInfo');
    const firstBtn = document.getElementById('firstPageBtn');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const lastBtn = document.getElementById('lastPageBtn');

    // í˜ì´ì§€ ì •ë³´ í‘œì‹œ (ë¬¸ì„œ ìš”êµ¬ì‚¬í•­: totalPages í™œìš©)
    pageInfo.textContent = `${currentPage} / ${totalPages} í˜ì´ì§€`;

    // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    firstBtn.disabled = currentPage === 1;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage >= totalPages;
    lastBtn.disabled = currentPage >= totalPages;

    // ë¹„í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼
    [firstBtn, prevBtn, nextBtn, lastBtn].forEach(btn => {
      if (btn.disabled) {
        btn.classList.add('cursor-not-allowed', 'opacity-50');
      } else {
        btn.classList.remove('cursor-not-allowed', 'opacity-50');
      }
    });
  }

  function goToPage(page) {
    if (page < 1 || page > totalPages) return;
    
    loadPosts(page);
    
    // í˜ì´ì§€ ì´ë™ ì‹œ ìŠ¤í¬ë¡¤ ìµœìƒë‹¨ìœ¼ë¡œ
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function renderPosts() {
    const search = searchBox.value.toLowerCase();
    postsTableBody.innerHTML = "";

    if (!Array.isArray(currentPosts)) {
      postsTableBody.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-red-500'>ë°ì´í„° ì˜¤ë¥˜ ë°œìƒ.</td></tr>";
      return;
    }

    const filtered = currentPosts.filter(p => {
      const titleMatch = p && typeof p.title === 'string' && p.title.toLowerCase().includes(search);
      const authorMatch = p && typeof p.authorId === 'string' && p.authorId.toLowerCase().includes(search);
      return titleMatch || authorMatch;
    });

    if (filtered.length === 0) {
      postsTableBody.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-gray-500'>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
      return;
    }

    filtered.forEach((p, index) => {
      if (!p || typeof p !== 'object' || !p.postId) {
        console.warn(`Skipping invalid post data at index ${index}:`, p);
        return;
      }

      const tr = document.createElement("tr");
      tr.className = "border-b cursor-pointer hover:bg-gray-50 transition-colors";

      let dateOnly = '';
      if (p.timestamp) {
        try {
          dateOnly = p.timestamp.split(' ')[0].replace(/\.$/, '');
        } catch (e) {
          console.warn(`Error parsing timestamp for post ${p.postId}:`, p.timestamp, e);
        }
      }

      try {
        const tdTitle = document.createElement("td");
        tdTitle.className = "p-3";
        tdTitle.textContent = p.title || "";
        tr.appendChild(tdTitle);

        const tdAuthor = document.createElement("td");
        tdAuthor.className = "p-3 w-24 text-center";
        tdAuthor.textContent = p.authorId || "";
        tr.appendChild(tdAuthor);

        const tdDate = document.createElement("td");
        tdDate.className = "p-3 w-28 text-center text-gray-600";
        tdDate.textContent = dateOnly;
        tr.appendChild(tdDate);

        const tdViews = document.createElement("td");
        tdViews.className = "p-3 w-16 text-center text-gray-600";
        tdViews.textContent = p.views !== undefined && p.views !== null ? p.views : 0;
        tr.appendChild(tdViews);

        tr.onclick = () => showDetail(p.postId);
        postsTableBody.appendChild(tr);
      } catch (e) {
        console.error(`Error rendering row for post at index ${index}:`, p, e);
      }
    });
  }

  async function submitPost() {
    const title = document.getElementById("title").value;
    const content = document.getElementById("content").value;
    const postPassword = document.getElementById("postPassword").value;
    const file = imageFileInput.files[0];

    if (!currentUser) {
      resultMsg.textContent = "âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
      return;
    }

    if (!title || !content) {
      resultMsg.textContent = "âŒ ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    if (!postPassword) {
      resultMsg.textContent = "âŒ ê²Œì‹œê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    submitButton.disabled = true;
    loadingSpinner.classList.remove("hidden");
    resultMsg.textContent = "ë“±ë¡ ì¤‘...";

    const postData = {
      communityId: currentCommunity,
      title: title,
      authorId: currentUser.userId,
      content: content,
      postPassword: postPassword,
      imageData: null,
      imageName: null,
      imageType: null
    };

    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        resultMsg.textContent = "âŒ ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        submitButton.disabled = false;
        loadingSpinner.classList.add("hidden");
        imageFileInput.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const base64String = e.target.result.split(',')[1];
        if (!base64String) {
          resultMsg.textContent = "âŒ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
          submitButton.disabled = false;
          loadingSpinner.classList.add("hidden");
          return;
        }
        postData.imageData = base64String;
        postData.imageName = file.name;
        postData.imageType = file.type;
        callAddPostApi(postData);
      };
      reader.onerror = function (e) {
        console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:", e);
        resultMsg.textContent = "âŒ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        submitButton.disabled = false;
        loadingSpinner.classList.add("hidden");
      };
      try {
        reader.readAsDataURL(file);
      } catch (readErr) {
        console.error("FileReader readAsDataURL error:", readErr);
        resultMsg.textContent = "âŒ íŒŒì¼ ì½ê¸° ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
        submitButton.disabled = false;
        loadingSpinner.classList.add("hidden");
      }
    } else {
      callAddPostApi(postData);
    }
  }

  async function callAddPostApi(dataToSend) {
    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "addPost", data: dataToSend })
      });

      const res = await response.json();

      resultMsg.textContent = res.message || "ì‘ë‹µ ë©”ì‹œì§€ ì—†ìŒ";

      if (res && res.success === true) {
        document.getElementById("title").value = "";
        document.getElementById("content").value = "";
        document.getElementById("postPassword").value = "";
        imageFileInput.value = "";
        setTimeout(() => { resultMsg.textContent = ""; }, 1500);
        currentPage = 1; // ìƒˆ ê¸€ ì‘ì„± í›„ ì²« í˜ì´ì§€ë¡œ
        loadPosts(1);
      } else {
        console.error("Server returned success:false:", res ? res.message : "No message");
      }

      submitButton.disabled = false;
      loadingSpinner.classList.add("hidden");
    } catch (err) {
      console.error("addPost API fetch failure:", err);
      resultMsg.textContent = `âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${err.message}`;
      submitButton.disabled = false;
      loadingSpinner.classList.add("hidden");
    }
  }

  async function showDetail(postId) {
    if (!postId) {
      console.error("showDetail: Invalid postId.");
      return;
    }

    const post = currentPosts.find(p => p && p.postId && p.postId.toString() === postId.toString());
    if (!post) {
      alert("ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    currentPostId = postId;
    postWriteForm.classList.add("hidden");
    searchBox.classList.add("hidden");
    postsList.classList.add("hidden");
    document.getElementById("pagination").classList.add("hidden");
    postDetail.classList.remove("hidden");

    document.getElementById("detailTitle").textContent = post.title || "ì œëª© ì—†ìŒ";
    document.getElementById("detailMeta").textContent = `ì‘ì„±ì: ${post.authorId || "ìµëª…"} | ë‚ ì§œ: ${post.timestamp || "ì•Œ ìˆ˜ ì—†ìŒ"} | ì¡°íšŒìˆ˜: ${post.views || 0}`;

    // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼
    const actionsEl = document.getElementById("detailActions");
    actionsEl.innerHTML = "";
    
    const editBtn = document.createElement("button");
    editBtn.className = "bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600";
    editBtn.textContent = "ìˆ˜ì •";
    editBtn.onclick = () => showPasswordModal('edit');
    actionsEl.appendChild(editBtn);

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600";
    deleteBtn.textContent = "ì‚­ì œ";
    deleteBtn.onclick = () => showPasswordModal('delete');
    actionsEl.appendChild(deleteBtn);

    detailImageContainer.innerHTML = "";

    if (post.imageId && typeof post.imageId === 'string' && post.imageId.trim() !== "") {
      const imageUrl = `${WEB_APP_URL}?action=getImage&id=${post.imageId}`;
      detailImageContainer.innerHTML = '<p class="text-gray-500 text-sm">ì´ë¯¸ì§€ ë¡œë”© ì¤‘...</p>';

      try {
        const response = await fetch(imageUrl);
        if (!response.ok) {
          throw new Error(`ì´ë¯¸ì§€ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ ${response.status}`);
        }

        const base64Content = await response.text();

        if (base64Content && typeof base64Content === 'string' && !base64Content.startsWith("Error") && base64Content.length > 100) {
          let mimeType = "image/unknown";
          const signature = base64Content.substring(0, 20);
          if (signature.startsWith("/9j/")) mimeType = "image/jpeg";
          else if (signature.startsWith("iVBORw")) mimeType = "image/png";
          else if (signature.startsWith("R0lGOD")) mimeType = "image/gif";
          else if (signature.startsWith("UklGR")) mimeType = "image/webp";
          else if (signature.startsWith("PHN2Zy")) mimeType = "image/svg+xml";

          const img = document.createElement("img");
          img.src = `data:${mimeType};base64,${base64Content}`;
          img.alt = (post.title || "ê²Œì‹œê¸€") + " ì´ë¯¸ì§€";
          img.className = "max-w-full h-auto rounded shadow my-4";
          img.onerror = () => {
            console.error("ì´ë¯¸ì§€ í‘œì‹œ ì‹¤íŒ¨:", post.imageId);
            detailImageContainer.innerHTML = '<p class="text-red-500 text-sm">ì´ë¯¸ì§€ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>';
          };
          detailImageContainer.innerHTML = "";
          detailImageContainer.appendChild(img);
        } else {
          throw new Error(base64Content && base64Content.startsWith("Error") ? base64Content : "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ë°ì´í„°");
        }
      } catch (err) {
        console.error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", err);
        detailImageContainer.innerHTML = `<p class="text-red-500 text-sm">ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${err.message}</p>`;
      }
    }

    document.getElementById("detailContentDisplay").textContent = post.content || "";
    document.getElementById("detailEditForm").classList.add("hidden");
    document.getElementById("detailContentDisplay").classList.remove("hidden");

    // ì¡°íšŒìˆ˜ ì¦ê°€
    if (currentPostId) {
      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ 
            action: "incrementViews", 
            data: { postId: currentPostId, communityId: currentCommunity } 
          })
        });
      } catch (err) {
        console.error("ì¡°íšŒìˆ˜ ì¦ê°€ ì‹¤íŒ¨:", err);
      }

      loadComments();
    }
  }

  function backToList() {
    postDetail.classList.add("hidden");
    currentPostId = null;
    detailImageContainer.innerHTML = "";
    document.getElementById("commentsList").innerHTML = "";
    postWriteForm.classList.remove("hidden");
    searchBox.classList.remove("hidden");
    postsList.classList.remove("hidden");
    searchBox.value = "";
    if (currentCommunity) {
      loadPosts();
    }
  }

  // ===== ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ëª¨ë‹¬ =====
  function showPasswordModal(action) {
    currentPasswordModalAction = action;
    const modal = document.getElementById('passwordModal');
    document.getElementById('modalPasswordInput').value = "";
    document.getElementById('modalPasswordError').textContent = "";
    modal.classList.add('active');
  }

  function closePasswordModal() {
    document.getElementById('passwordModal').classList.remove('active');
    currentPasswordModalAction = null;
  }

  async function submitPasswordModal() {
    const password = document.getElementById('modalPasswordInput').value;
    const errorEl = document.getElementById('modalPasswordError');

    if (!password) {
      errorEl.textContent = "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    if (currentPasswordModalAction === 'edit') {
      enterEditMode(password);
      closePasswordModal();
    } else if (currentPasswordModalAction === 'delete') {
      await submitDelete(password);
    }
  }

  function enterEditMode(password) {
    const post = currentPosts.find(p => p.postId === currentPostId);
    if (!post) return;

    document.getElementById("detailContentDisplay").classList.add("hidden");
    document.getElementById("detailEditForm").classList.remove("hidden");
    document.getElementById("editContent").value = post.content;
    document.getElementById("editContent").dataset.password = password;
  }

  function cancelEdit() {
    document.getElementById("detailEditForm").classList.add("hidden");
    document.getElementById("detailContentDisplay").classList.remove("hidden");
  }

  async function submitUpdate() {
    const newContent = document.getElementById("editContent").value;
    const password = document.getElementById("editContent").dataset.password;

    if (!newContent) {
      alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "updatePost",
          data: {
            postId: currentPostId,
            postPassword: password,
            newContent: newContent,
            communityId: currentCommunity
          }
        })
      });

      const result = await response.json();

      if (result.success) {
        alert(result.message);
        backToList();
      } else {
        alert(result.message || "ìˆ˜ì • ì‹¤íŒ¨");
      }
    } catch (err) {
      console.error("ê²Œì‹œê¸€ ìˆ˜ì • ì˜¤ë¥˜:", err);
      alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  async function submitDelete(password) {
    if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      closePasswordModal();
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "deletePost",
          data: {
            postId: currentPostId,
            postPassword: password,
            communityId: currentCommunity
          }
        })
      });

      const result = await response.json();

      if (result.success) {
        alert(result.message);
        closePasswordModal();
        currentPage = 1; // ì‚­ì œ í›„ ì²« í˜ì´ì§€ë¡œ
        showMain(); // ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê±°ë‚˜
        openCommunity(currentCommunity); // ê°™ì€ ì»¤ë®¤ë‹ˆí‹° ì²« í˜ì´ì§€
      } else {
        document.getElementById('modalPasswordError').textContent = result.message || "ì‚­ì œ ì‹¤íŒ¨";
      }
    } catch (err) {
      console.error("ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:", err);
      alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // ===== ëŒ“ê¸€ ê´€ë¦¬ =====
  async function submitComment() {
    if (!currentPostId) return;

    // ë¬¸ì œ í•´ê²°: authorId ì „ì†¡ (authorNicknameì´ ì•„ë‹˜!)
    const commentData = {
      postId: currentPostId,
      communityId: currentCommunity,
      authorId: currentUser ? currentUser.userId : document.getElementById("commentAuthor").value, // authorId!
      content: document.getElementById("commentContent").value
    };

    if (!commentData.authorId || !commentData.content) {
      alert("ì‘ì„±ìì™€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "addComment", data: commentData })
      });

      const res = await response.json();

      if (res && res.success === true) {
        loadComments();
        document.getElementById("commentAuthor").value = "";
        document.getElementById("commentContent").value = "";
      } else {
        alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (err) {
      console.error("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", err);
      alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  async function loadComments() {
    if (!currentPostId) return;

    try {
      const response = await fetch(`${WEB_APP_URL}?action=getComments&postId=${currentPostId}&communityId=${encodeURIComponent(currentCommunity)}`);
      const data = await response.json();

      const container = document.getElementById("commentsList");
      container.innerHTML = "";

      if (!data || !Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<p class='text-gray-500 text-sm'>ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      data.forEach((c) => {
        if (!c || typeof c !== 'object') return;
        const div = document.createElement("div");
        div.className = "border-b border-gray-200 py-3";
        const author = c.authorNickname || "ìµëª…";
        const time = c.timestamp || "";
        const commentContent = c.content || "";
        div.innerHTML = `
          <p class="font-semibold">${author} <span class="text-xs text-gray-500 font-normal">(${time})</span></p>
          <p class="text-gray-700 whitespace-pre-wrap">${commentContent}</p>`;
        container.appendChild(div);
      });
    } catch (err) {
      console.error("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:", err);
      document.getElementById("commentsList").innerHTML = "<p class='text-red-500 text-sm'>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>";
    }
  }

  // ===== ë¬¸ì˜í•˜ê¸° =====
  async function submitInquiry() {
    const content = inquiryContentEl.value;
    if (!content || content.trim() === "") {
      inquiryMsgEl.textContent = "âŒ ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }

    inquiryMsgEl.textContent = "ì „ì†¡ ì¤‘...";

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "addInquiry", data: { content: content } })
      });

      const res = await response.json();

      inquiryMsgEl.textContent = res.success ? "âœ… ë¬¸ì˜ ë“±ë¡ ì„±ê³µ!" : (res.message || "ì˜¤ë¥˜ ë°œìƒ");

      if (res && res.success === true) {
        inquiryContentEl.value = "";
        setTimeout(() => {
          if (inquiryMsgEl.textContent === "âœ… ë¬¸ì˜ ë“±ë¡ ì„±ê³µ!") {
            inquiryMsgEl.textContent = "";
          }
        }, 2000);
      }
    } catch (err) {
      console.error("ë¬¸ì˜ ë“±ë¡ ì‹¤íŒ¨:", err);
      inquiryMsgEl.textContent = "âŒ ë¬¸ì˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
    }
  }

  // ===== ì¹œêµ¬ ê´€ë¦¬ =====
  function showFriendTab(tab) {
    document.getElementById('friendListTab').className = "px-4 py-2 font-semibold text-gray-500";
    document.getElementById('friendSearchTab').className = "px-4 py-2 font-semibold text-gray-500";
    document.getElementById('friendRequestsTab').className = "px-4 py-2 font-semibold text-gray-500";
    document.getElementById('friendListView').classList.add('hidden');
    document.getElementById('friendSearchView').classList.add('hidden');
    document.getElementById('friendRequestsView').classList.add('hidden');

    if (tab === 'list') {
      document.getElementById('friendListTab').className = "px-4 py-2 font-semibold border-b-2 border-[#3B4890] text-[#3B4890]";
      document.getElementById('friendListView').classList.remove('hidden');
      loadFriendList();
    } else if (tab === 'search') {
      document.getElementById('friendSearchTab').className = "px-4 py-2 font-semibold border-b-2 border-[#3B4890] text-[#3B4890]";
      document.getElementById('friendSearchView').classList.remove('hidden');
    } else if (tab === 'requests') {
      document.getElementById('friendRequestsTab').className = "px-4 py-2 font-semibold border-b-2 border-[#3B4890] text-[#3B4890]";
      document.getElementById('friendRequestsView').classList.remove('hidden');
      loadPendingRequests();
    }
  }

  async function loadFriendList() {
    if (!currentUser) return;

    try {
      const response = await fetch(`${WEB_APP_URL}?action=getFriendList&userId=${currentUser.userId}`);
      const result = await response.json();

      const container = document.getElementById('friendList');
      container.innerHTML = "";

      if (result.success && result.friends && result.friends.length > 0) {
        result.friends.forEach(friend => {
          const div = document.createElement('div');
          div.className = "flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer";
          div.innerHTML = `
            <div>
              <p class="font-semibold">${friend.nickname}</p>
              <p class="text-sm text-gray-500">${friend.userId}</p>
            </div>
            <button onclick="openChatWithFriend('${friend.chatRoomId}', '${friend.nickname}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">ì±„íŒ…</button>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p class='text-gray-500 text-sm'>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
      }
    } catch (err) {
      console.error("ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
    }
  }

  async function searchFriend() {
    const query = document.getElementById('friendSearchInput').value;
    if (!query) {
      alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "searchUser", data: { query } })
      });

      const result = await response.json();

      const container = document.getElementById('searchResults');
      container.innerHTML = "";

      if (result.success && result.users && result.users.length > 0) {
        result.users.forEach(user => {
          if (user.userId === currentUser.userId) return; // ìê¸° ìì‹  ì œì™¸

          const div = document.createElement('div');
          div.className = "flex justify-between items-center p-3 bg-gray-50 rounded";
          div.innerHTML = `
            <div>
              <p class="font-semibold">${user.nickname}</p>
              <p class="text-sm text-gray-500">${user.userId}</p>
            </div>
            <button onclick="sendFriendRequest('${user.userId}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">ì¹œêµ¬ ìš”ì²­</button>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p class='text-gray-500 text-sm'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
      }
    } catch (err) {
      console.error("ì‚¬ìš©ì ê²€ìƒ‰ ì‹¤íŒ¨:", err);
    }
  }

  async function sendFriendRequest(targetId) {
    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "sendFriendRequest",
          data: { userA_Id: currentUser.userId, userB_Id: targetId }
        })
      });

      const result = await response.json();
      alert(result.message);
    } catch (err) {
      console.error("ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨:", err);
      alert("ì¹œêµ¬ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  async function loadPendingRequests() {
    if (!currentUser) return;

    try {
      const response = await fetch(`${WEB_APP_URL}?action=getPendingRequests&userId=${currentUser.userId}`);
      const result = await response.json();

      const container = document.getElementById('pendingRequests');
      container.innerHTML = "";

      if (result.success && result.requests && result.requests.length > 0) {
        result.requests.forEach(request => {
          const div = document.createElement('div');
          div.className = "flex justify-between items-center p-3 bg-gray-50 rounded";
          div.innerHTML = `
            <div>
              <p class="font-semibold">${request.nickname}</p>
              <p class="text-sm text-gray-500">${request.userId}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="acceptFriendRequest('${request.userId}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">ìˆ˜ë½</button>
              <button onclick="declineFriendRequest('${request.userId}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">ê±°ì ˆ</button>
            </div>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p class='text-gray-500 text-sm'>ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
      }
    } catch (err) {
      console.error("ì¹œêµ¬ ìš”ì²­ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
    }
  }

  async function acceptFriendRequest(requesterId) {
    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "acceptFriendRequest",
          data: { requesterId: requesterId, accepterId: currentUser.userId }
        })
      });

      const result = await response.json();
      alert(result.message);
      loadPendingRequests();
      loadFriendList();
    } catch (err) {
      console.error("ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½ ì‹¤íŒ¨:", err);
      alert("ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  async function declineFriendRequest(requesterId) {
    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "declineFriendRequest",
          data: { requesterId: requesterId, declinerId: currentUser.userId }
        })
      });

      const result = await response.json();
      alert(result.message);
      loadPendingRequests();
    } catch (err) {
      console.error("ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ ì‹¤íŒ¨:", err);
      alert("ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // ===== ì±„íŒ… ì‹œìŠ¤í…œ =====
  function openChatWithFriend(chatRoomId, friendNickname) {
    currentChatRoomId = chatRoomId;
    document.getElementById('chatWindowTitle').textContent = friendNickname;
    document.getElementById('chatWindow').classList.remove('hidden');
    loadChatMessages();

    // 3ì´ˆë§ˆë‹¤ ë©”ì‹œì§€ í´ë§
    if (chatPollingInterval) clearInterval(chatPollingInterval);
    chatPollingInterval = setInterval(loadChatMessages, 3000);
  }

  function closeChatWindow() {
    document.getElementById('chatWindow').classList.add('hidden');
    currentChatRoomId = null;
    if (chatPollingInterval) {
      clearInterval(chatPollingInterval);
      chatPollingInterval = null;
    }
  }

  async function loadChatMessages() {
    if (!currentChatRoomId) return;

    try {
      const response = await fetch(`${WEB_APP_URL}?action=getMessages&chatRoomId=${currentChatRoomId}`);
      const messages = await response.json();

      const container = document.getElementById('chatMessages');
      container.innerHTML = "";

      if (Array.isArray(messages) && messages.length > 0) {
        messages.forEach(msg => {
          const isMine = msg.senderId === currentUser.userId;
          const div = document.createElement('div');
          div.className = `message-bubble ${isMine ? 'message-mine' : 'message-theirs'}`;
          
          let content = "";
          if (msg.messageType === 'image') {
            content = `<img src="${WEB_APP_URL}?action=getImage&id=${msg.content}" class="max-w-full rounded" alt="ì±„íŒ… ì´ë¯¸ì§€" />`;
          } else {
            content = msg.content;
          }

          div.innerHTML = `
            ${msg.replyToMessageId ? `<div class="reply-indicator">â†© ë‹µì¥</div>` : ''}
            <div>${content}</div>
            <div class="text-xs opacity-70 mt-1">${msg.timestamp}</div>
          `;
          container.appendChild(div);
        });

        container.scrollTop = container.scrollHeight;
      }
    } catch (err) {
      console.error("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:", err);
    }
  }

  async function sendChatMessage() {
    const input = document.getElementById('chatMessageInput');
    const content = input.value.trim();

    if (!content) return;

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "sendMessage",
          data: {
            chatRoomId: currentChatRoomId,
            senderId: currentUser.userId,
            messageType: 'text',
            content: content
          }
        })
      });

      const result = await response.json();

      if (result.success) {
        input.value = "";
        loadChatMessages();
      }
    } catch (err) {
      console.error("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", err);
    }
  }

  async function handleChatImage() {
    const fileInput = document.getElementById('chatImageInput');
    const file = fileInput.files[0];

    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      alert("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      fileInput.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
      const base64String = e.target.result.split(',')[1];

      try {
        const response = await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({
            action: "sendMessage",
            data: {
              chatRoomId: currentChatRoomId,
              senderId: currentUser.userId,
              messageType: 'image',
              imageData: base64String,
              imageName: file.name,
              imageType: file.type
            }
          })
        });

        const result = await response.json();

        if (result.success) {
          fileInput.value = "";
          loadChatMessages();
        } else {
          alert("ì´ë¯¸ì§€ ì „ì†¡ ì‹¤íŒ¨: " + result.message);
        }
      } catch (err) {
        console.error("ì´ë¯¸ì§€ ì „ì†¡ ì‹¤íŒ¨:", err);
        alert("ì´ë¯¸ì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };

    reader.readAsDataURL(file);
  }

  // ===== ì´ˆê¸°í™” ì‹¤í–‰ =====
  init();
</script>
</body>
</html>
