<!DOCTYPE html>
<html lang="ko">
<head>
Â  <meta charset="UTF-8" />
Â  <title>ì˜ê³¼ê³ inside</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <style>
Â  Â  /* (ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼) */
Â  Â  .liked { color: #ef4444; font-weight: bold; }
Â  Â  .dc-table-header { border-top: 2px solid #333; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3B4890; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
Â  </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

<!-- (HTML êµ¬ì¡°ëŠ” ì´ì „ê³¼ ë™ì¼) -->
<header class="w-full bg-white text-[#3B4890] shadow-md sticky top-0 z-10">
  <div class="max-w-5xl mx-auto p-4 flex justify-between items-center">
Â  Â  <h1 class="text-3xl font-bold cursor-pointer" onclick="showMain()">ì˜ê³¼ê³ inside</h1>
Â  Â  <button id="refreshButton" class="bg-[#3B4890] text-white font-semibold py-1 px-3 rounded text-sm hover:bg-[#2F3A78] transition"> ğŸ”„ ìƒˆë¡œê³ ì¹¨ </button>
Â  </div>
</header>

<div id="app" class="max-w-5xl mx-auto p-4">
Â  <div class="mb-4 bg-[#3B4890] p-2 rounded-lg shadow-md">
Â  Â  <button onclick="openGuide()" class="bg-gray-200 text-[#3B4890] px-4 py-2 rounded shadow hover:bg-gray-300 transition-colors font-semibold"> ğŸ“¢ ì•ˆë‚´ì‚¬í•­ </button>
Â  Â  <button onclick="openInquiry()" class="bg-gray-200 text-[#3B4890] px-4 py-2 rounded shadow hover:bg-gray-300 transition-colors ml-2 font-semibold"> âœ‰ï¸ ë¬¸ì˜í•˜ê¸° </button>
Â  </div>
  <!-- (ì•ˆë‚´ì‚¬í•­, ë¬¸ì˜í•˜ê¸° í˜ì´ì§€ HTMLì€ ì´ì „ê³¼ ë™ì¼) -->
Â  <div id="guidePage" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
    <button onclick="closeGuide()" class="bg-gray-200 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold"> â† ëŒì•„ê°€ê¸° </button>
    <h2 class="text-2xl font-bold mb-4 border-b pb-2">ğŸ“¢ ì•ˆë‚´ì‚¬í•­</h2>
    <div class="space-y-2 text-gray-700">
      <p>1. ìš•ì„¤, ë¹„ë°© ê¸ˆì§€.</p>
      <p>2. ì‘ì„±ê¸€ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
      <p class="pl-4 text-sm">IP ìˆ˜ì§‘ì¤‘ì´ë©° í…ŒëŸ¬ë‚˜ ë¬¸ì œë˜ëŠ” ìƒí™©ì´ ì•„ë‹Œ ë‹¤ë¥¸ ìš©ë„ë¡œ ì ˆëŒ€ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p>3. ì„œë²„ ìì›ì´ ë¶€ì¡±í•  ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>
      <p>4. í…ŒëŸ¬ í•˜ì§€ ë§ˆì„¸ìš” (IPì£¼ì†Œë¡œ ë³´ë³µí•©ë‹ˆë‹¤.)</p>
      <p>5. ì—¬ëŸ¬ë¶„ì´ ê²Œì‹œí•œ ê¸€ë“¤ì€ AI í•™ìŠµ ë°ì´í„°ë¡œ ì‚¬ìš©ë˜ë©° ìµëª…ì„ ë³´ì¥í•©ë‹ˆë‹¤.</p>
      <p>6. í•˜ì§€ë§Œ ê°œì¸ì •ë³´ë¥¼ ê²Œì‹œí•  ê²½ìš° í•™ìŠµë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê°€ê¸‰ì  ê°œì¸ì •ë³´ ê²Œì‹œë¥¼ ìì œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
      <p>7. ë¬¸ì˜ì‚¬í•­ì€ ë¬¸ì˜í•˜ê¸°ì—ì„œ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
      <p>8. ë²„ê·¸ë‚˜ ë¬¸ì œì ë“±ë„ ë¬¸ì˜í•˜ê¸°ì—ì„œ ì‘ì„±í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.</p>
      <p>9. ì¶”í›„ ì—…ë°ì´íŠ¸ê°€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.</p>
      <p>10. ì´ ì‚¬ì´íŠ¸ì—ì„œ í™œë™í•˜ëŠ”ê²ƒì€ ìœ„ ì‚¬í•­ì— ë™ì˜í•˜ëŠ”ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.</p>
      <p>11. ì‚­ì œ ìš”ì²­ì€ ì•„ë˜ ì´ë©”ì¼ë¡œ ì •í™•í•œ ê¸€ê³¼ ì‚¬ìœ , ìº¡ì³ë³¸ì„ ë³´ë‚´ì£¼ì…”ì•¼ ì§„í–‰ë©ë‹ˆë‹¤.</p>
      <p class="font-semibold">ì´ë©”ì¼ : 2024010203@ushs.hs.kr</p>
    </div>
  </div>
Â  <div id="inquiryPage" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
    <button onclick="closeInquiry()" class="bg-gray-200 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold"> â† ëŒì•„ê°€ê¸° </button>
    <h2 class="text-2xl font-bold mb-4 border-b pb-2">âœ‰ï¸ ë¬¸ì˜í•˜ê¸°</h2>
    <textarea id="inquiryContent" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="border p-2 mb-2 w-full rounded h-32 focus:outline-none focus:ring-2 focus:ring-[#3B4890]"></textarea>
    <button onclick="submitInquiry()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors"> ë¬¸ì˜ ì „ì†¡ </button>
    <p id="inquiryMsg" class="mt-2 text-sm"></p>
  </div>
Â  <div id="mainPage" class="grid gap-4 mb-6"></div>
Â  <div id="communityPage" class="hidden">
    <button onclick="showMain()" class="bg-gray-200 border border-gray-300 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold"> â† ë©”ì¸ìœ¼ë¡œ </button>
    <h2 id="communityTitle" class="text-3xl font-bold mb-4 text-[#3B4890]"></h2>
    <!-- ê¸€ì“°ê¸° í¼ -->
Â  Â  <div id="postWriteForm" class="bg-white p-4 rounded-lg shadow-md mb-4">
      <input id="title" placeholder="ì œëª©" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <input id="author" placeholder="ì‘ì„±ì" class="border w-full p-2 mb-2 rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
      <textarea id="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="border w-full p-2 mb-2 rounded h-28 focus:outline-none focus:ring-2 focus:ring-[#3B4890]"></textarea>
      <div class="mb-2">
        <label for="imageFile" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ ì²¨ë¶€ (ì„ íƒ, 5MB ì´í•˜):</label>
        <input type="file" id="imageFile" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#e0e7ff] file:text-[#3B4890] hover:file:bg-[#c7d2fe]">
      </div>
Â  Â  Â  <button id="submitBtn" onclick="submitPost()" class="bg-[#3B4890] text-white px-4 py-2 rounded hover:bg-[#2F3A78] transition-colors font-semibold disabled:opacity-50"> ê¸€ ë“±ë¡ </button>
      <span id="loadingSpinner" class="loader hidden"></span> 
Â  Â  Â  <p id="resultMsg" class="mt-2 text-sm"></p>
Â  Â  </div>
    <!-- ê²€ìƒ‰ -->
Â  Â  <input id="searchBox" type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”." oninput="renderPosts()" class="border w-full p-2 mb-4 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
Â  Â  <div id="postsList" class="bg-white rounded-lg shadow-md overflow-hidden">
      <table class="w-full text-sm dc-table-header">
        <thead class="bg-gray-50">
          <tr class="border-b">
            <th class="p-3 text-left">ì œëª©</th>
            <th class="p-3 w-24">ì‘ì„±ì</th>
            <th class="p-3 w-28">ë‚ ì§œ</th>
            <th class="p-3 w-16">ì¡°íšŒ</th>
          </tr>
        </thead>
        <tbody id="postsTableBody"></tbody>
      </table>
    </div>
    <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
Â  Â  <div id="postDetail" class="hidden bg-white p-6 rounded-lg shadow-md">
      <button onclick="backToList()" class="bg-gray-200 border border-gray-300 px-3 py-1 rounded mb-4 hover:bg-gray-300 text-sm font-semibold"> â† ëª©ë¡ìœ¼ë¡œ </button>
      <div class="border-b-2 border-gray-300 pb-3 mb-3">
        <h2 id="detailTitle" class="text-2xl font-bold mb-2"></h2>
        <div id="detailMeta" class="text-sm text-gray-600 bg-gray-50 p-2 rounded"></div>
      </div>
      <div id="detailImageContainer" class="mb-4"></div> 
      <div id="detailContent" class="mb-5 whitespace-pre-wrap min-h-[100px]"></div>
      <!-- ëŒ“ê¸€ -->
      <div class="border-t pt-4">
        <h3 class="font-bold mb-3 text-lg">ğŸ’¬ ëŒ“ê¸€</h3>
        <div id="commentsList" class="mb-4"></div>
        <div class="bg-gray-50 p-3 rounded"> 
          <input id="commentAuthor" placeholder="ì‘ì„±ì" class="border p-2 mb-2 w-full rounded focus:outline-none focus:ring-2 focus:ring-[#3B4890]" />
          <textarea id="commentContent" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="border p-2 mb-2 w-full rounded h-20 focus:outline-none focus:ring-2 focus:ring-[#3B4890]"></textarea>
          <button onclick="submitComment()" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 font-semibold"> ëŒ“ê¸€ ë“±ë¡ </button>
        </div>
      </div> 
    </div>
Â  </div>
</div>

<script>
  // â—â— [ì¤‘ìš”] ì—¬ê¸°ì— Code.gsë¥¼ "ìƒˆ ë°°í¬"í•œ í›„ ì–»ì€ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyTNAisK8Igwjxy-P9fQT7NtFnI7ht92vDnaovjnl0KScZZSa3ijpL1iKwFwiPgcJ5SoA/exec"; 

Â  const communityGroups = {
    "ì „ì²´": ["ì „ì²´ ì»¤ë®¤ë‹ˆí‹°"],
    "ìˆ˜í•™Â·ê³¼í•™": ["ìˆ˜í•™ ì»¤ë®¤ë‹ˆí‹°", "ê³¼í•™ ì»¤ë®¤ë‹ˆí‹°"],
    "ì˜ì¬í•™êµ": [
      "í•œêµ­ê³¼í•™ì˜ì¬í•™êµ", "ì„œìš¸ê³¼í•™ê³ ë“±í•™êµ", "ê²½ê¸°ê³¼í•™ê³ ë“±í•™êµ", "ì„¸ì¢…ê³¼í•™ì˜ˆìˆ ì˜ì¬í•™êµ",
      "ì¸ì²œê³¼í•™ì˜ˆìˆ ì˜ì¬í•™êµ", "ëŒ€êµ¬ê³¼í•™ê³ ë“±í•™êµ", "ëŒ€ì „ê³¼í•™ê³ ë“±í•™êµ", "ê´‘ì£¼ê³¼í•™ê³ ë“±í•™êµ"
    ],
    "ê³¼í•™ê³ ": [
      "í•œì„±ê³¼í•™ê³ ë“±í•™êµ", "ì„¸ì¢…ê³¼í•™ê³ ë“±í•™êµ", "ë¶€ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ë¶€ì‚°ì¼ê³¼í•™ê³ ë“±í•™êµ",
      "ëŒ€êµ¬ì¼ê³¼í•™ê³ ë“±í•™êµ", "ì¸ì²œê³¼í•™ê³ ë“±í•™êµ", "ì¸ì²œì§„ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ëŒ€ì „ë™ì‹ ê³¼í•™ê³ ë“±í•™êµ",
      "ìš¸ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ê²½ê¸°ë¶ê³¼í•™ê³ ë“±í•™êµ", "ê°•ì›ê³¼í•™ê³ ë“±í•™êµ", "ì¶©ë¶ê³¼í•™ê³ ë“±í•™êµ",
      "ì¶©ë‚¨ê³¼í•™ê³ ë“±í•™êµ", "ì „ë¶ê³¼í•™ê³ ë“±í•™êµ", "ì „ë‚¨ê³¼í•™ê³ ë“±í•™êµ", "ê²½ë¶ê³¼í•™ê³ ë“±í•™êµ",
      "ê²½ì‚°ê³¼í•™ê³ ë“±í•™êµ", "ê²½ë‚¨ê³¼í•™ê³ ë“±í•™êµ", "ì°½ì›ê³¼í•™ê³ ë“±í•™êµ", "ì œì£¼ê³¼í•™ê³ ë“±í•™êµ"
    ]
  };
Â  let currentCommunity = null;
Â  let currentPosts = [];
Â  let currentPostId = null;
  // let webAppUrl = null; // [ì‚­ì œ] ìƒìˆ˜ë¡œ ëŒ€ì²´

Â  // DOM ì°¸ì¡°
Â  const mainPage = document.getElementById("mainPage");
  const communityPage = document.getElementById("communityPage");
  const guidePage = document.getElementById("guidePage");
  const inquiryPage = document.getElementById("inquiryPage");
  const postWriteForm = document.getElementById("postWriteForm");
  const searchBox = document.getElementById("searchBox");
  const postsList = document.getElementById("postsList");
  const postDetail = document.getElementById("postDetail");
  const postsTableBody = document.getElementById("postsTableBody");
  const imageFileInput = document.getElementById("imageFile"); 
  const submitButton = document.getElementById("submitBtn");
  const loadingSpinner = document.getElementById("loadingSpinner");
  const resultMsg = document.getElementById("resultMsg");
  const detailImageContainer = document.getElementById("detailImageContainer");
  const inquiryContentEl = document.getElementById("inquiryContent"); 
  const inquiryMsgEl = document.getElementById("inquiryMsg"); 

  // [ì‚­ì œ] getWebAppUrl í•¨ìˆ˜ (ì´ì œ ìƒìˆ˜ë¥¼ ì‚¬ìš©)
  // function getWebAppUrl() { ... }

Â  // ë©”ì¸ í˜ì´ì§€ ë Œë”ë§ (ë³€ê²½ ì—†ìŒ)
Â  function renderMainPage() {
    mainPage.innerHTML = "";
    Object.keys(communityGroups).forEach(groupName => { 
        const container = document.createElement("div");
        container.className = "bg-white p-4 rounded-lg shadow-md mb-4";
        const header = document.createElement("h3");
        header.className = "font-bold text-lg mb-3 border-b-2 border-[#3B4890] pb-2";
        header.textContent = groupName; 
        container.appendChild(header);
        const btnDiv = document.createElement("div");
        btnDiv.className = "flex flex-wrap gap-2";
        communityGroups[groupName].forEach(c => {
            const btn = document.createElement("button");
            btn.className = "bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-50 hover:border-[#3B4890] hover:text-[#3B4890] transition-colors";
            btn.textContent = c; 
            btn.onclick = () => openCommunity(c); // [ìˆ˜ì •] async ì œê±°
            btnDiv.appendChild(btn);
        });
        container.appendChild(btnDiv);
        mainPage.appendChild(container);
    });
  }

Â  // í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜ë“¤ (ë³€ê²½ ì—†ìŒ)
  function showMain() {
    currentCommunity = null; currentPosts = []; currentPostId = null;
    mainPage.classList.remove("hidden"); communityPage.classList.add("hidden");
    guidePage.classList.add("hidden"); inquiryPage.classList.add("hidden");
  }
  function openGuide() {
    mainPage.classList.add("hidden"); communityPage.classList.add("hidden");
    guidePage.classList.remove("hidden"); inquiryPage.classList.add("hidden");
  }
  function closeGuide() {
    guidePage.classList.add("hidden"); mainPage.classList.remove("hidden");
  }
  function openInquiry() {
    mainPage.classList.add("hidden"); communityPage.classList.add("hidden");
    guidePage.classList.add("hidden"); inquiryPage.classList.remove("hidden");
  }
  function closeInquiry() {
    inquiryPage.classList.add("hidden"); mainPage.classList.remove("hidden");
    inquiryContentEl.value = ""; 
    inquiryMsgEl.textContent = ""; 
  }
  // [ìˆ˜ì •] openCommunity (async ë° URL í™•ì¸ ë¡œì§ ì¶”ê°€)
  function openCommunity(communityId) { 
    if (!WEB_APP_URL || WEB_APP_URL.includes("YOUR_NEW_APPS_SCRIPT_URL_HERE")) {
        alert("ì˜¤ë¥˜: ì›¹ ì•± URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. index.html ìƒë‹¨ì˜ WEB_APP_URL ìƒìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        return;
    }
    currentCommunity = communityId;
    mainPage.classList.add("hidden");
    communityPage.classList.remove("hidden");
    document.getElementById("communityTitle").textContent = communityId; 
    backToList(); // ëª©ë¡ UI ë³´ì´ê²Œ ì´ˆê¸°í™” (ë‚´ë¶€ì—ì„œ loadPosts í˜¸ì¶œ X)
    loadPosts();  // ì—¬ê¸°ì„œ loadPosts í˜¸ì¶œ
  }

Â  // [ìˆ˜ì •] ê²Œì‹œê¸€ ë¡œë“œ - fetch ì‚¬ìš©
  function loadPosts() {
    if (!currentCommunity) {
        console.warn("loadPosts: currentCommunity is null");
        return;
    }
    console.log("loadPosts called for community:", currentCommunity);
    postsTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
    
    // google.script.run ëŒ€ì‹  fetch (GET) ì‚¬ìš©
    fetch(`${WEB_APP_URL}?action=getPosts&community=${encodeURIComponent(currentCommunity)}`)
      .then(response => {
          if (!response.ok) {
              // ì˜¤ë¥˜ ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹± ì‹œë„
              return response.json().then(errData => {
                  throw new Error(errData.message || `Network response was not ok: ${response.statusText}`);
              }).catch(() => {
                  // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ
                  throw new Error(`Network response was not ok: ${response.statusText}`);
              });
          }
          return response.json();
      })
      .then(data => {
        console.log("getPosts success. Data received:", data); 
        // [ìˆ˜ì •] APIê°€ {success: false, ...} ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸
        if (data && data.success === false) {
             console.error("getPosts API Error:", data.message);
             postsTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${data.message}</td></tr>`;
             currentPosts = [];
             return;
        }
        if (!Array.isArray(data)) {
            console.error("getPosts did not return an array:", data);
            postsTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜.</td></tr>';
            currentPosts = []; 
            return;
        }
        currentPosts = data;
        renderPosts();
      })
      .catch(err => {
         console.error("getPosts fetch failed:", err);
         postsTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
      });
  }

Â  // [ìˆ˜ì •] ê²Œì‹œê¸€ ë Œë”ë§ - createElement ì‚¬ìš©
Â  function renderPosts() {
Â  Â  const search = searchBox.value.toLowerCase();
Â  Â  postsTableBody.innerHTML = ""; 
    
    if (!Array.isArray(currentPosts)) {
        postsTableBody.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-red-500'>ë°ì´í„° ì˜¤ë¥˜ ë°œìƒ.</td></tr>";
        return;
    }

Â  Â  const filtered = currentPosts.filter(
Â  Â  Â  (p) => {
          const titleMatch = p && typeof p.title === 'string' && p.title.toLowerCase().includes(search);
          const authorMatch = p && typeof p.authorNickname === 'string' && p.authorNickname.toLowerCase().includes(search);
          return titleMatch || authorMatch;
       }
Â  Â  );

Â  Â  if (filtered.length === 0) {
Â  Â  Â  postsTableBody.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-gray-500'>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
Â  Â  Â  return;
Â  Â  }

Â  Â  filtered.forEach((p, index) => { 
      if (!p || typeof p !== 'object' || !p.postId) {
          console.warn(`Skipping invalid post data or missing postId at index ${index}:`, p);
          return; 
      }

Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  tr.className = "border-b cursor-pointer hover:bg-gray-50 transition-colors";
Â  Â  Â  
      let dateOnly = '';
      if (p.timestamp) {
          try { dateOnly = p.timestamp.split(' ')[0].replace(/\.$/, ''); } 
          catch (e) { console.warn(`Error parsing timestamp for post ${p.postId}:`, p.timestamp, e); }
      }

      try {
        const tdTitle = document.createElement("td");
        tdTitle.className = "p-3"; 
        tdTitle.textContent = p.title || ""; 
        tr.appendChild(tdTitle); 

        const tdAuthor = document.createElement("td");
        tdAuthor.className = "p-3 w-24 text-center"; 
        tdAuthor.textContent = p.authorNickname || ""; 
        tr.appendChild(tdAuthor); 

        const tdDate = document.createElement("td");
        tdDate.className = "p-3 w-28 text-center text-gray-600"; 
        tdDate.textContent = dateOnly; 
        tr.appendChild(tdDate); 

        const tdViews = document.createElement("td");
        tdViews.className = "p-3 w-16 text-center text-gray-600"; 
        tdViews.textContent = p.views !== undefined && p.views !== null ? p.views : 0; 
        tr.appendChild(tdViews); 

        tr.onclick = () => showDetail(p.postId);
        postsTableBody.appendChild(tr); 
      } catch (e) {
          console.error(`Error rendering row for post at index ${index}:`, p, e);
      }
Â  Â  });
Â  }

  // [ìˆ˜ì •] submitPost í•¨ìˆ˜ - fetch (POST) ì‚¬ìš©
  function submitPost() {
    const title = document.getElementById("title").value;
    const author = document.getElementById("author").value;
    const content = document.getElementById("content").value;
    const file = imageFileInput.files[0]; 

    if (!title || !author || !content) {
      resultMsg.textContent = "âŒ ì œëª©, ì‘ì„±ì, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }
    if (!WEB_APP_URL || WEB_APP_URL.includes("YOUR_")) {
        resultMsg.textContent = "âŒ ì˜¤ë¥˜: API URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
    }

    submitButton.disabled = true;
    loadingSpinner.classList.remove("hidden");
    resultMsg.textContent = "ë“±ë¡ ì¤‘..."; 

    const postData = {
      communityId: currentCommunity,
      title: title, authorNickname: author, content: content,
      imageData: null, imageName: null, imageType: null
    };

    if (file) {
      if (file.size > 5 * 1024 * 1024) { 
          resultMsg.textContent = "âŒ ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          submitButton.disabled = false;
          loadingSpinner.classList.add("hidden");
          imageFileInput.value = ""; 
          return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64String = e.target.result.split(',')[1]; 
        if (!base64String) { 
            resultMsg.textContent = "âŒ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
            submitButton.disabled = false;
            loadingSpinner.classList.add("hidden");
            return;
        }
        postData.imageData = base64String;
        postData.imageName = file.name;
        postData.imageType = file.type;
        callAddPostApi(postData); 
      };
      reader.onerror = function(e) {
         console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:", e);
         resultMsg.textContent = "âŒ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
         submitButton.disabled = false;
         loadingSpinner.classList.add("hidden");
      };
      try { reader.readAsDataURL(file); } 
      catch (readErr) {
          console.error("FileReader readAsDataURL error:", readErr);
          resultMsg.textContent = "âŒ íŒŒì¼ ì½ê¸° ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
          submitButton.disabled = false;
          loadingSpinner.classList.add("hidden");
      }
    } else {
      callAddPostApi(postData);
    }
  }

  // [ìˆ˜ì •] callAddPostApi - fetch (POST) ì‚¬ìš©
  function callAddPostApi(dataToSend) {
      console.log("Calling fetch POST addPost with data:", { ...dataToSend, imageData: dataToSend.imageData ? '[Base64 Data]' : null }); 
      
      fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors", // CORS ëª¨ë“œ ëª…ì‹œ
        cache: "no-cache",
        headers: {
          // [ìˆ˜ì •] Code.gsì˜ doPostê°€ JSON.parse(e.postData.contents)ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ text/plain ì‚¬ìš©
          "Content-Type": "text/plain;charset=utf-8", 
        },
        body: JSON.stringify({ // ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
          action: "addPost",
          data: dataToSend 
        })
      })
      .then(response => {
          if (!response.ok) {
             return response.json().then(err => { throw new Error(err.message || `Server Error: ${response.statusText}`); });
          }
          return response.json(); 
      }) 
      .then(res => {
          console.log("addPost API success:", res); 
          resultMsg.textContent = res.message || "ì‘ë‹µ ë©”ì‹œì§€ ì—†ìŒ"; 
          if (res && res.success === true) { 
            document.getElementById("title").value = "";
            document.getElementById("author").value = "";
            document.getElementById("content").value = "";
            imageFileInput.value = ""; 
            setTimeout(() => { resultMsg.textContent = ""; }, 1500); 
            loadPosts(); 
          } else {
             console.error("Server returned success:false:", res ? res.message : "No message");
          }
          submitButton.disabled = false;
          loadingSpinner.classList.add("hidden");
        })
        .catch(err => {
           console.error("addPost API fetch failure:", err); 
           resultMsg.textContent = `âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${err.message}`; 
           submitButton.disabled = false;
           loadingSpinner.classList.add("hidden");
        });
  }

Â  // [ìˆ˜ì •] showDetail í•¨ìˆ˜ - fetch (GET) ì‚¬ìš©
Â  function showDetail(postId) { 
    if (!postId) { console.error("showDetail: Invalid postId."); return; }
    console.log("Showing detail for postId:", postId);

    if (!WEB_APP_URL || WEB_APP_URL.includes("YOUR_")) { /* ... (URL ì—†ìŒ ì˜¤ë¥˜) ... */ return; }
    if (!Array.isArray(currentPosts)) { /* ... (ë°°ì—´ ì•„ë‹˜ ì˜¤ë¥˜) ... */ return; }
    
    const post = currentPosts.find(p => p && p.postId && p.postId.toString() === postId.toString()); 
Â  Â  if (!post) { /* ... (ê²Œì‹œê¸€ ì—†ìŒ ì˜¤ë¥˜) ... */ return; }
Â  Â  
Â  Â  currentPostId = postId; 
Â  Â  postWriteForm.classList.add("hidden"); searchBox.classList.add("hidden"); postsList.classList.add("hidden");
Â  Â  postDetail.classList.remove("hidden");
Â  Â  document.getElementById("detailTitle").textContent = post.title || "ì œëª© ì—†ìŒ";
Â  Â  document.getElementById("detailMeta").textContent = `ì‘ì„±ì: ${post.authorNickname || "ìµëª…"} | ë‚ ì§œ: ${post.timestamp || "ì•Œ ìˆ˜ ì—†ìŒ"} | ì¡°íšŒìˆ˜: ${post.views || 0}`;
    
    detailImageContainer.innerHTML = ""; 
    
    // [ìˆ˜ì •] Code.gsê°€ imageIdë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ post.imageIdë¡œ í™•ì¸
    if (post.imageId && typeof post.imageId === 'string' && post.imageId.trim() !== "") { 
        const imageUrl = `${WEB_APP_URL}?action=getImage&id=${post.imageId}`; 
        console.log("Fetching image via proxy URL:", imageUrl); 
        
        detailImageContainer.innerHTML = '<p class="text-gray-500 text-sm">ì´ë¯¸ì§€ ë¡œë”© ì¤‘...</p>'; 
        
        fetch(imageUrl) 
          .then(response => {
              if (!response.ok) {
                  return response.text().then(text => { 
                      throw new Error(`ì´ë¯¸ì§€ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ ${response.status}: ${text || response.statusText}`);
                  });
              }
              return response.text(); 
          })
          .then(base64Content => {
               if (base64Content && typeof base64Content === 'string' && !base64Content.startsWith("Error") && base64Content.length > 100) { 
                  let mimeType = "image/unknown"; 
                  const signature = base64Content.substring(0, 20); 
                  if (signature.startsWith("/9j/")) mimeType = "image/jpeg";
                  else if (signature.startsWith("iVBORw")) mimeType = "image/png";
                  else if (signature.startsWith("R0lGOD")) mimeType = "image/gif";
                  else if (signature.startsWith("UklGR")) mimeType = "image/webp"; 
                  else if (signature.startsWith("PHN2Zy")) mimeType = "image/svg+xml";
                  
                  const img = document.createElement("img");
                  img.src = `data:${mimeType};base64,${base64Content}`; 
                  img.alt = (post.title || "ê²Œì‹œê¸€") + " ì´ë¯¸ì§€"; 
                  img.className = "max-w-full h-auto rounded shadow my-4"; 
                  img.onerror = () => { 
                      console.error("ì´ë¯¸ì§€ í‘œì‹œ ì‹¤íŒ¨ (Data URL):", post.imageId);
                      detailImageContainer.innerHTML = '<p class="text-red-500 text-sm">ì´ë¯¸ì§€ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>'; 
                  };
                  detailImageContainer.innerHTML = ""; 
                  detailImageContainer.appendChild(img); 
               } else {
                   const errorMessage = base64Content && base64Content.startsWith("Error") ? base64Content : "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ë°ì´í„° ìˆ˜ì‹ .";
                   throw new Error(errorMessage);
               }
          })
          .catch(err => {
              console.error("ì´ë¯¸ì§€ í”„ë¡ì‹œ fetch/ì²˜ë¦¬ ì‹¤íŒ¨:", err);
              detailImageContainer.innerHTML = `<p class="text-red-500 text-sm">ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${err.message}</p>`;
          });

    } else {
        // console.log("No valid imageId found for this post.");
        detailImageContainer.innerHTML = ""; 
    }
    
Â  Â  document.getElementById("detailContent").textContent = post.content || ""; 

    // [ìˆ˜ì •] ì¡°íšŒìˆ˜ ì¦ê°€ - fetch POST ì‚¬ìš©
    if (currentPostId) {
        console.log("Calling incrementViews for postId:", currentPostId);
        fetch(WEB_APP_URL, {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
              action: "incrementViews",
              data: { postId: currentPostId } 
            })
        })
        .then(response => response.json())
        .then(res => {
            if (!res.success) console.error("incrementViews failed:", res);
        })
        .catch(err => console.error(`ì¡°íšŒìˆ˜ ì¦ê°€ fetch ì‹¤íŒ¨ (postId: ${currentPostId}):`, err)); 
        
        loadComments(); // ëŒ“ê¸€ ë¡œë“œ
    } else {
        console.error("Cannot call incrementViews/loadComments: currentPostId is invalid.");
    }
Â  }

Â  // [ìˆ˜ì •] backToList - loadPosts() í˜¸ì¶œ ì¶”ê°€
  function backToList() {
    console.log("Back to list clicked.");
    postDetail.classList.add("hidden");
    currentPostId = null; 
    detailImageContainer.innerHTML = ""; 
    document.getElementById("commentsList").innerHTML = ""; 
    postWriteForm.classList.remove("hidden");
    searchBox.classList.remove("hidden");
    postsList.classList.remove("hidden");
    searchBox.value = "";
    if (currentCommunity) {
      loadPosts(); // [ìˆ˜ì •] ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }
  }
  
  // [ìˆ˜ì •] submitComment - fetch (POST) ì‚¬ìš©
  function submitComment() {
    if (!currentPostId) { /* ... */ return; }
    const commentData = {
      postId: currentPostId,
      authorNickname: document.getElementById("commentAuthor").value,
      content: document.getElementById("commentContent").value
    };
    if (!commentData.authorNickname || !commentData.content) { /* ... */ return; }
    
    console.log("Submitting comment via fetch:", commentData);
    fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "addComment", data: commentData })
    })
      .then(response => response.json())
      .then(res => {
        if (res && res.success === true) {
            console.log("submitComment success.");
            loadComments();
            document.getElementById("commentAuthor").value = "";
            document.getElementById("commentContent").value = "";
        } else {
            console.error("ëŒ“ê¸€ ë“±ë¡ ì„œë²„ ì²˜ë¦¬ ì‹¤íŒ¨:", res ? res.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
            alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      })
      .catch(err => {
         console.error("ëŒ“ê¸€ ë“±ë¡ fetch ì‹¤íŒ¨:", err);
         alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }
  
  // [ìˆ˜ì •] loadComments - fetch (GET) ì‚¬ìš©
  function loadComments() {
    if (!currentPostId) { /* ... */ return; }
    console.log("Loading comments via fetch for postId:", currentPostId); 
    
    fetch(`${WEB_APP_URL}?action=getComments&postId=${currentPostId}`)
      .then(response => response.json())
      .then(data => {
        console.log("getComments success. Data:", data); 
        const container = document.getElementById("commentsList");
        container.innerHTML = "";
        if (!data || !Array.isArray(data) || data.length === 0) { 
          container.innerHTML = "<p class='text-gray-500 text-sm'>ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }
        data.forEach((c) => {
          if (!c || typeof c !== 'object') { /* ... */ return; }
          const div = document.createElement("div");
          div.className = "border-b border-gray-200 py-3";
          const author = c.authorNickname || "ìµëª…";
          const time = c.timestamp || "";
          const commentContent = c.content || "";
          div.innerHTML = `
            <p class="font-semibold">${author} <span class="text-xs text-gray-500 font-normal">(${time})</span></p>
            <p class="text-gray-700 whitespace-pre-wrap">${commentContent}</p>`;
          container.appendChild(div);
        });
      })
      .catch(err => {
         console.error(`ëŒ“ê¸€ ë¡œë“œ fetch ì‹¤íŒ¨ (postId: ${currentPostId}):`, err);
         document.getElementById("commentsList").innerHTML = "<p class='text-red-500 text-sm'>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>";
      });
  }
  
  // [ìˆ˜ì •] submitInquiry - fetch (POST) ì‚¬ìš©
  function submitInquiry() {
    const content = inquiryContentEl.value;
    if (!content || content.trim() === "") {
      inquiryMsgEl.textContent = "âŒ ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }
    
    const submitInquiryButton = inquiryPage.querySelector('button[onclick="submitInquiry()"]');
    if (submitInquiryButton) submitInquiryButton.disabled = true;
    inquiryMsgEl.textContent = "ì „ì†¡ ì¤‘...";

    console.log("Submitting inquiry via fetch:", content);
    fetch(WEB_APP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        // [ìˆ˜ì •] Code.gsì˜ addInquiry í•¨ìˆ˜ê°€ inquiry.contentë¥¼ ê¸°ëŒ€í•˜ë¯€ë¡œ
        body: JSON.stringify({ action: "addInquiry", data: { content: content } }) 
    })
      .then(response => response.json())
      .then(res => {
        console.log("submitInquiry success:", res);
        // [ìˆ˜ì •] Code.gsì˜ addInquiry ì‘ë‹µì´ {success: true}ë§Œ ë°˜í™˜í•˜ë¯€ë¡œ ë©”ì‹œì§€ ìˆ˜ì •
        inquiryMsgEl.textContent = res.success ? "âœ… ë¬¸ì˜ ë“±ë¡ ì„±ê³µ!" : (res.message || "ì˜¤ë¥˜ ë°œìƒ");
        if (res && res.success === true) {
          inquiryContentEl.value = "";
          setTimeout(() => { 
            if (inquiryMsgEl.textContent === "âœ… ë¬¸ì˜ ë“±ë¡ ì„±ê³µ!") {
                 inquiryMsgEl.textContent = ""; 
            }
          }, 2000);
        }
        if (submitInquiryButton) submitInquiryButton.disabled = false;
      })
      .catch(err => {
         console.error("ë¬¸ì˜ ë“±ë¡ fetch ì‹¤íŒ¨:", err);
         inquiryMsgEl.textContent = "âŒ ë¬¸ì˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
         if (submitInquiryButton) submitInquiryButton.disabled = false;
      });
  }

Â  // ì´ˆê¸° ë Œë”ë§ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
Â  renderMainPage();
  // [ì‚­ì œ] í˜ì´ì§€ ë¡œë“œ ì‹œ getWebAppUrl() í˜¸ì¶œ (openCommunityì—ì„œ ì²˜ë¦¬)
Â  
Â  document.getElementById('refreshButton').addEventListener('click', () => {
Â  Â  if (currentCommunity) {
      console.log("Refresh button clicked for community:", currentCommunity);
      loadPosts(); 
    } else {
      console.log("Refresh button clicked on main page.");
      renderMainPage(); 
    }
Â  });

</script>
</body>
</html>
